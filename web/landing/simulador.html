<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Avanzado - Residencia IoT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f0f2f5; overflow-x: hidden; }
        .navbar { background-color: #2c3e50; }
        .navbar-brand, .nav-link { color: white !important; }
        
        .simulator-card { background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding: 30px; height: 100%; position: relative; }
        .log-container { background: #1e1e1e; color: #4ade80; font-family: 'Fira Code', 'Courier New', monospace; border-radius: 12px; padding: 20px; height: 500px; overflow-y: auto; font-size: 0.85rem; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        
        /* Escenario de Simulaci贸n */
        .stage {
            position: relative;
            width: 100%;
            height: 300px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid #dee2e6;
            margin-bottom: 20px;
        }

        /* Sensor PIR */
        .sensor-unit {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            text-align: center;
        }
        .sensor-eye {
            width: 40px;
            height: 20px;
            background: #fff;
            border-radius: 20px 20px 5px 5px;
            border: 2px solid #adb5bd;
            margin: 0 auto;
            position: relative;
        }
        .sensor-eye.active {
            background: #ff4757;
            box-shadow: 0 0 15px #ff4757;
            border-color: #c0392b;
        }

        /* Zona de Detecci贸n (Cono) */
        .detection-cone {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 260px;
            background: rgba(52, 152, 219, 0.1);
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            transition: background 0.3s;
        }
        .detection-cone.active {
            background: rgba(231, 76, 60, 0.2);
        }

        /* Humano Animado */
        .human {
            position: absolute;
            bottom: 20px;
            left: -50px;
            font-size: 3.5rem;
            transition: left 0.1s linear;
            z-index: 20;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .human-walking {
            animation: walk-bounce 0.5s infinite alternate;
        }
        @keyframes walk-bounce {
            from { transform: translateY(0) rotate(-5deg); }
            to { transform: translateY(-10px) rotate(5deg); }
        }

        .status-panel {
            padding: 15px;
            border-radius: 10px;
            background: #f8f9fa;
            border-left: 5px solid #6c757d;
            margin-bottom: 20px;
        }
        .status-panel.alarm {
            border-left-color: #e74c3c;
            background: #fff5f5;
        }

        .log-entry { border-bottom: 1px solid #333; padding: 8px 0; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }
        .log-time { color: #7f8c8d; font-size: 0.75rem; }
        .log-type-alert { color: #ff6b6b; font-weight: bold; }
        .log-type-info { color: #4db8ff; }

        .btn-sim { border-radius: 50px; padding: 12px 30px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

        /* Notification Styling */
        .notification-item {
            position: relative;
            background-color: #343a40; /* Dark background */
            color: white;
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transform: translateY(20px);
            animation: slideIn 0.3s forwards;
            min-width: 250px;
            max-width: 350px;
        }

        .notification-item.alert-success { background-color: #28a745; }
        .notification-item.alert-primary { background-color: #007bff; }
        .notification-item .close-btn {
            position: absolute;
            top: 5px;
            right: 10px;
            color: white;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
        }

        @keyframes slideIn {
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(20px); }
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand" href="index.html"> Residencia IoT</a>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
                    <li class="nav-item"><a class="nav-link active" href="simulador.html">Simulador</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <div class="row g-4">
            <!-- Panel de Simulaci贸n -->
            <div class="col-lg-7">
                <div class="simulator-card">
                    <h2 class="fw-bold mb-4"><i class="bi bi-cpu"></i> Entorno de Prueba Realista</h2>
                    
                    <div id="statusPanel" class="status-panel">
                        <h5 class="mb-1" id="statusTitle">Sistema en Reposo</h5>
                        <p class="small text-muted mb-0" id="statusDesc">Esperando detecci贸n en el campo de visi贸n del sensor PIR.</p>
                    </div>

                    <div class="row mb-3">
                        <div class="col-6">
                            <div class="card p-3 text-center">
                                <h6 class="mb-1 text-muted">Personas Contadas</h6>
                                <h3 id="peopleCount" class="fw-bold text-primary">0</h3>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card p-3 text-center">
                                <h6 class="mb-1 text-muted">Estado de Residencia</h6>
                                <h3 id="residenceState" class="fw-bold text-success">Vac铆a</h3>
                            </div>
                        </div>
                    </div>

                    <div class="stage" id="stage">
                        <!-- Sensor -->
                        <div class="sensor-unit">
                            <div id="sensorEye" class="sensor-eye"></div>
                            <small class="fw-bold" style="font-size: 0.6rem;">HC-SR501 PIR</small>
                        </div>
                        
                        <!-- Cono de detecci贸n -->
                        <div id="cone" class="detection-cone"></div>

                        <!-- El Humano -->
                        <div id="human" class="human">
                            <i class="bi bi-person-walking"></i>
                        </div>
                    </div>

                    <div class="text-center">
                        <button id="startWalk" class="btn btn-primary btn-sim shadow-sm">
                            <i class="bi bi-play-fill"></i> Iniciar Recorrido
                        </button>
                        <button id="resetSim" class="btn btn-outline-secondary btn-sim ms-2">
                            <i class="bi bi-arrow-counterclockwise"></i> Reset Simulaci贸n
                        </button>
                        <button id="clearCount" class="btn btn-warning btn-sim ms-2">
                            <i class="bi bi-eraser"></i> Limpiar Contador
                        </button>
                    </div>

                    <div class="mt-4 p-3 bg-light rounded-3">
                        <h6><i class="bi bi-info-circle"></i> 驴C贸mo funciona?</h6>
                        <p class="small text-muted mb-0">Al pulsar "Iniciar Recorrido", el algoritmo calcula la posici贸n del "humano" en tiempo real. Cuando sus coordenadas coinciden con el <strong>cono de detecci贸n</strong> (simulando los 120掳 del PIR f铆sico), se dispara la interrupci贸n en el c贸digo Arduino simulado.</p>
                    </div>

                    <!-- Notification Area -->
                    <div id="notificationArea" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;"></div>
                </div>
            </div>

            <!-- Panel de Logs -->
            <div class="col-lg-5">
                <div class="simulator-card">
                    <h2 class="fw-bold mb-4"><i class="bi bi-terminal"></i> Monitor Serial</h2>
                    <div id="logContainer" class="log-container">
                        <!-- Logs will be dynamically added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const human = document.getElementById('human');
        const stage = document.getElementById('stage');
        const cone = document.getElementById('cone');
        const sensorEye = document.getElementById('sensorEye');
        const startBtn = document.getElementById('startWalk');
        const resetBtn = document.getElementById('resetSim');
        const clearCountBtn = document.getElementById('clearCount'); // New button
        const logContainer = document.getElementById('logContainer');
        const statusPanel = document.getElementById('statusPanel');
        const statusTitle = document.getElementById('statusTitle');
        const statusDesc = document.getElementById('statusDesc');
        const peopleCountDisplay = document.getElementById('peopleCount');
        const residenceStateDisplay = document.getElementById('residenceState');
        const notificationArea = document.getElementById('notificationArea');

        let posX = -50;
        let isWalking = false;
        let animationFrame;
        let hasDetectedInThisPass = false;
        let peopleCounter = 0;
        let isSomeoneInside = false; // Tracks if someone is currently inside the detection zone

        function addLog(type, msg) {
            const now = new Date();
            const time = now.toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const typeClass = type === 'ALERTA' ? 'log-type-alert' : 'log-type-info';
            entry.innerHTML = `<span class="log-time">${time}</span> <span class="${typeClass}">[${type}]</span> <span class="text-white">${msg}</span>`;
            logContainer.prepend(entry);
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification-item alert-${type}`;
            notification.innerHTML = `
                ${message}
                <button type="button" class="close-btn" onclick="this.parentElement.remove();">&times;</button>
            `;
            notificationArea.appendChild(notification);

            setTimeout(() => {
                if (notification.parentElement === notificationArea) { // Check if not already closed by user
                    notification.style.animation = 'slideOut 0.3s forwards';
                    notification.addEventListener('animationend', () => notification.remove());
                }
            }, 5000); // Notification disappears after 5 seconds
        }

        function updateSimulation() {
            if (!isWalking) return;

            posX += 2.5; // Velocidad del paso
            human.style.left = posX + 'px';

            const stageWidth = stage.offsetWidth;
            const humanCenter = posX + 25; // Approximate center of the human icon
            const coneLeft = (stageWidth / 2) - 60; // Left boundary of the cone
            const coneRight = (stageWidth / 2) + 60; // Right boundary of the cone

            const isHumanInCone = (humanCenter > coneLeft && humanCenter < coneRight);

            if (isHumanInCone) {
                if (!hasDetectedInThisPass) {
                    triggerAlarm();
                    hasDetectedInThisPass = true;
                }
                if (!isSomeoneInside) { // User just entered
                    peopleCounter++;
                    peopleCountDisplay.textContent = peopleCounter;
                    residenceStateDisplay.textContent = 'Ocupada';
                    residenceStateDisplay.classList.remove('text-success');
                    residenceStateDisplay.classList.add('text-danger');
                    showNotification('El usuario ha entrado en la residencia.', 'success');
                    addLog('INFO', 'Actualizado: Estado de Residencia a "Ocupada".');
                    isSomeoneInside = true;
                }
            } else {
                if (hasDetectedInThisPass && humanCenter >= coneRight) {
                    // Human has left the cone after being detected
                    stopAlarm();
                    hasDetectedInThisPass = false;
                    if (isSomeoneInside) { // User just left
                        residenceStateDisplay.textContent = 'Vac铆a';
                        residenceStateDisplay.classList.remove('text-danger');
                        residenceStateDisplay.classList.add('text-success');
                        showNotification('El usuario ha abandonado la residencia.', 'primary');
                        addLog('INFO', 'Actualizado: Estado de Residencia a "Vac铆a".');
                        isSomeoneInside = false;
                    }
                }
            }

            if (posX > stageWidth) {
                resetHuman();
            } else {
                animationFrame = requestAnimationFrame(updateSimulation);
            }
        }

        function triggerAlarm() {
            sensorEye.classList.add('active');
            cone.classList.add('active');
            statusPanel.classList.add('alarm');
            statusTitle.innerText = " MOVIMIENTO DETECTADO";
            statusTitle.classList.add('text-danger');
            statusDesc.innerText = "El sensor PIR ha enviado una se帽al HIGH al Pin Digital 3.";
            addLog('ALERTA', '隆Intrusi贸n detectada! Activando Buzzer y grabaci贸n.');
            
            // Placeholder for audio feedback - not implemented
            // const audioFeedback = new Audio('data:audio/wav;base66...'); 
        }

        function stopAlarm() {
            sensorEye.classList.remove('active');
            cone.classList.remove('active');
            statusPanel.classList.remove('alarm');
            statusTitle.innerText = "Sistema en Reposo";
            statusTitle.classList.remove('text-danger');
            statusDesc.innerText = "Sujeto ha salido del 谩rea de cobertura.";
            addLog('INFO', 'Sensor PIR vuelve a estado LOW (Standby).');
        }

        function resetHuman() {
            isWalking = false;
            posX = -50;
            human.style.left = posX + 'px';
            human.classList.remove('human-walking');
            startBtn.disabled = false;
            cancelAnimationFrame(animationFrame);
            // Reset only simulation-specific states, not the counter
            isSomeoneInside = false;
            residenceStateDisplay.textContent = 'Vac铆a';
            residenceStateDisplay.classList.remove('text-danger');
            residenceStateDisplay.classList.add('text-success');
            logContainer.innerHTML = '<div class="log-entry"><span class="log-type-info">[SISTEMA]</span> <span class="text-white">Simulaci贸n reiniciada.</span></div>';
        }

        function clearCounter() {
            peopleCounter = 0;
            peopleCountDisplay.textContent = peopleCounter;
            showNotification('Contador de personas reiniciado.', 'info');
            addLog('INFO', 'Contador de personas reiniciado.');
        }

        startBtn.addEventListener('click', () => {
            if (isWalking) return;
            isWalking = true;
            hasDetectedInThisPass = false;
            human.classList.add('human-walking');
            startBtn.disabled = true;
            addLog('INFO', 'Iniciando simulaci贸n de trayecto peatonal...');
            updateSimulation();
        });

        resetBtn.addEventListener('click', () => {
            resetHuman();
        });

        clearCountBtn.addEventListener('click', () => { // New event listener
            clearCounter();
        });
    </script>
</body>
</html>